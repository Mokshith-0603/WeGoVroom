rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
          || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
        );
    }

    // User profiles
    match /users/{userId} {
      allow read: if signedIn();
      allow write: if request.auth.uid == userId;
    }

    // Trips collection
    match /trips/{tripId} {
      allow read: if signedIn();
      allow create: if signedIn() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && 
                               resource.data.ownerId == request.auth.uid;
    }

    // Trip participants
    match /tripParticipants/{participant} {
      allow read, list: if signedIn();
      allow create, write, delete: if signedIn();
    }

    // Trip requests/join requests
    match /tripRequests/{request} {
      allow read, list: if signedIn();
      allow create, write, delete: if signedIn();
    }

    // Trip chat messages
    match /tripMessages/{message} {
      allow read, list: if signedIn();
      allow create: if signedIn() && 
                       request.resource.data.senderId == request.auth.uid;
      allow delete: if request.auth.uid == resource.data.senderId;
    }

    // Drivers: visible to all signed-in users, add/update/delete by admins only
    match /drivers/{driverId} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // Notifications
    match /notifications/{docId} {
      // Admin can send notifications
      allow create: if isAdmin();

      // Users can read only their own notifications
      allow read: if signedIn() && resource.data.userId == uid();

      // Optional: admin can update notification status/fields if needed
      allow update: if isAdmin();

      allow delete: if false;
    }
  }
}
