rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function tripPath(tripId) {
      return /databases/$(database)/documents/trips/$(tripId);
    }

    function tripExists(tripId) {
      return exists(tripPath(tripId));
    }

    function tripData(tripId) {
      return get(tripPath(tripId)).data;
    }

    function tripOwnerId(tripId) {
      return tripData(tripId).ownerId;
    }

    function isTripOwner(tripId) {
      return signedIn() && tripExists(tripId) && tripOwnerId(tripId) == uid();
    }

    function canSelfJoinTrip(tripId) {
      return tripExists(tripId)
        && (
          tripData(tripId).isPublic != false
          || tripOwnerId(tripId) == uid()
          || (
            tripData(tripId).invitedUserIds is list
            && tripData(tripId).invitedUserIds.hasAny([uid()])
          )
          || (
            request.auth.token.email is string
            && tripData(tripId).invitedUserEmails is list
            && tripData(tripId).invitedUserEmails.hasAny([request.auth.token.email])
          )
        );
    }

    function isAdmin() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (
          request.auth.token.admin == true
          || request.auth.token.admin == 1
          || (request.auth.token.admin is string
            && request.auth.token.admin.matches('(?i)^\\s*(true|1|yes)\\s*$'))
          || request.auth.token.isAdmin == true
          || request.auth.token.isAdmin == 1
          || (request.auth.token.isAdmin is string
            && request.auth.token.isAdmin.matches('(?i)^\\s*(true|1|yes)\\s*$'))
          || (
            request.auth.token.role is string
            && request.auth.token.role.matches('(?i)^\\s*admin\\s*$')
          )
          || (userDoc.role is string && userDoc.role.matches('(?i)^\\s*admin\\s*$'))
          || userDoc.isAdmin == true
          || userDoc.isAdmin == 1
          || (userDoc.isAdmin is string
            && userDoc.isAdmin.matches('(?i)^\\s*(true|1|yes)\\s*$'))
          || userDoc.admin == true
          || userDoc.admin == 1
          || (userDoc.admin is string
            && userDoc.admin.matches('(?i)^\\s*(true|1|yes)\\s*$'))
        );
    }

    // User profiles
    match /users/{userId} {
      allow read: if signedIn();
      allow write: if request.auth.uid == userId;
    }

    // Trips collection
    match /trips/{tripId} {
      allow read: if signedIn();
      allow create: if signedIn() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if signedIn() && 
                               resource.data.ownerId == request.auth.uid;
    }

    // Trip participants
    match /tripParticipants/{participant} {
      allow read, list: if signedIn();
      allow create: if signedIn()
        && request.resource.data.tripId is string
        && request.resource.data.userId is string
        && (
          (
            request.resource.data.userId == uid()
            && canSelfJoinTrip(request.resource.data.tripId)
          )
          || isTripOwner(request.resource.data.tripId)
        );
      allow update: if false;
      allow delete: if signedIn();
    }

    // Trip requests/join requests
    match /tripRequests/{request} {
      allow read, list: if signedIn();
      allow create, write, delete: if signedIn();
    }

    // Trip chat messages
    match /tripMessages/{message} {
      allow read, list: if signedIn();
      allow create: if signedIn() && 
                       request.resource.data.senderId == request.auth.uid;
      allow delete: if request.auth.uid == resource.data.senderId;
    }

    // Trip reviews: visible to signed-in users
    match /tripReviews/{reviewId} {
      allow read, list: if signedIn();

      allow create: if signedIn()
        && request.resource.data.reviewerId == uid();

      allow update: if signedIn()
        && resource.data.reviewerId == uid()
        && request.resource.data.reviewerId == uid();

      allow delete: if signedIn()
        && (resource.data.reviewerId == uid() || isAdmin());
    }

    // User feedbacks: any signed-in user can submit, only admins can read all
    match /feedbacks/{feedbackId} {
      allow create: if signedIn()
        && request.resource.data.userId == uid();

      allow read, list: if isAdmin();

      allow update, delete: if false;
    }

    // Drivers: visible to all signed-in users, add/update/delete by admins only
    match /drivers/{driverId} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // Notifications
    match /notifications/{docId} {
      // Admin can send notifications
      allow create: if isAdmin();

      // Users can read only their own notifications
      allow read: if signedIn() && resource.data.userId == uid();

      // Optional: admin can update notification status/fields if needed
      allow update: if isAdmin();

      allow delete: if false;
    }
  }
}
